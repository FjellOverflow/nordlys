---
import config from '@/theme.config'
const defaultMode = 'auto' // 设置默认为自动模式
---

<script is:inline data-default-mode={defaultMode}>
  window.mode ??= (() => {
    const defaultMode = document.currentScript.getAttribute('data-default-mode')
    const storageKey = 'mode'
    const store =
      typeof localStorage !== 'undefined'
        ? localStorage
        : { getItem: () => null, setItem: () => {} }

    const mediaMatcher = window.matchMedia('(prefers-color-scheme: dark)')

    function applyMode(mode) {
      const isDark =
        mode === 'dark' || (mode === 'auto' && mediaMatcher.matches)

      document.documentElement.dataset.mode = isDark ? 'dark' : 'light'
      document.documentElement.style.colorScheme = isDark ? 'dark' : 'light'

      // 更新图标
      const span = document.querySelector('dark-light-toggle span')
      if (span) {
        span.className = `clickable iconify ${
          mode === 'auto' 
            ? 'tabler--sun-moon'
            : isDark 
              ? 'tabler--moon' 
              : 'tabler--sun'
        }`
      }
    }

    function setMode(mode = defaultMode) {
      store.setItem(storageKey, mode)
      applyMode(mode)
    }

    function getMode() {
      return store.getItem(storageKey) || defaultMode
    }

    // 监听系统主题变化
    mediaMatcher.addEventListener('change', (e) => {
      if (getMode() === 'auto') {
        applyMode('auto')
      }
    })

    return { setMode, getMode }
  })()

  mode.setMode(mode.getMode())
</script>
